<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title></title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://unpkg.com/bootstrap@4/dist/css/bootstrap.min.css">
        <script src='https://unpkg.com/jquery@3/dist/jquery.min.js'></script>
        <script src='https://unpkg.com/popper.js@1/dist/umd/popper.min.js'></script>
        <script src='https://unpkg.com/bootstrap@4/dist/js/bootstrap.min.js'></script>

        <!-- Interact.js -->
        <script src="https://unpkg.com/interactjs/dist/interact.min.js"></script>

        <style>

            * {
                margin:0;
                padding:0;
                box-sizing: border-box;
            }

            html, body {
                width:100%;
                height:100%;
            }

            /* 선택된 아이템 */
            .selected-item {
                border: solid 2px rgb(5, 65, 105) !important;
            }

            /* 갖다 놓을 공간 */
            #dropzone1 {
                height: 30rem;
            }

            /* 갖다 놓을 공간 공통 */
            .dropzone {
                background-color: #ccc;
                border: dashed 4px transparent;
                transition: background-color 0.3s;
            }

            .drop-active {
                border-color: #aaa;
            }

            .drop-target {
                background-color: #29e;
                border-color: #fff;
                border-style: solid;
            }

            .palette {
                display: table;
            }

            .palette-row {
                display: table-row;
            }

            /* 갖다 놓을 아이템 */
            .drag-drop {
                display: table-cell;
                width: 8em;
                height: 3em;
                color: #fff;
                background-color: #29e;
                border: solid 2px #fff;
                touch-action: none;
                -webkit-transform: translate(0px, 0px);
                        transform: translate(0px, 0px);
                transition: background-color 0.3s;
                text-align: center;
                vertical-align: middle;
            }

            .drag-drop.can-drop {
                color: #000;
                background-color: #4e4;
            }
        </style>
    </head>
    <body>

        <div class="container-fluid" style="padding:0;">
            <div class="row no-gutters">
                <div class="col-sm-10">
                    <div id="dropzone1" class="dropzone">
                        #dropzone1
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="palette">
                        <div class="palette-row">
                            <div palette="true" widget-type="TextView" class="drag-drop">
                                TextView
                            </div>
                        </div>
                        <div class="palette-row">
                            <div palette="true" widget-type="ImageView" class="drag-drop">
                                ImageView
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            
            let selectedItem = [];

            interact('.dropzone').dropzone({
                // 지정된 아이템만 드래그 가능하도록 함
                accept: '.drag-drop',
                
                // 드롭하기 위해 75% 이상 겹쳐야 함
                overlap: 0.75,

                // 이벤트 등록
                ondropactivate: function (event) {
                    // add active dropzone feedback
                    event.target.classList.add('drop-active')
                },
                ondragenter: function (event) {
                    var draggableElement = event.relatedTarget
                    var dropzoneElement = event.target

                    // feedback the possibility of a drop
                    dropzoneElement.classList.add('drop-target')
                    draggableElement.classList.add('can-drop')
                    //draggableElement.textContent = 'Dragged in'
                },
                ondragleave: function (event) {
                    // remove the drop feedback style
                    event.target.classList.remove('drop-target')
                    event.relatedTarget.classList.remove('can-drop')
                    //event.relatedTarget.textContent = 'Dragged out'
                },
                ondrop: function (event) {
                    // 끌어다 놓았을 때 이벤트

                    const widgetType = event.relatedTarget.getAttribute('widget-type');
                    console.log('widget type : ' + widgetType);

                    const state = event.relatedTarget.getAttribute('state');
                    console.log('state : ' + state);

                    // 가로/세로 크기 설정
                    if (state == 'initial') {
                        if (widgetType == 'TextView') {
                            event.relatedTarget.style.width = '200px'
                            event.relatedTarget.style.height = '100px'
        
                            event.relatedTarget.textContent = 'TextView';
                        } else if (widgetType == 'ImageView') {
                            event.relatedTarget.style.width = '200px'
                            event.relatedTarget.style.height = '200px'
        
                            const elem = document.createElement('img');
                            elem.setAttribute('src', 'images/person.png');
                            elem.setAttribute('width', '100%');
                            elem.setAttribute('height', '100%');

                            event.relatedTarget.innerHTML = '';
                            event.relatedTarget.appendChild(elem);

                        } 
                    }


                    //event.relatedTarget.textContent = 'Dropped'

                    // top/left 위치 확인
                    const targetTop = event.target.getAttribute('data-x');
                    const targetLeft = event.target.getAttribute('data-y');
                    console.log('dropzone top/left : ' + targetTop + ', ' + targetLeft);

                    console.log('dropitem bound : ' + event.relatedTarget.getBoundingClientRect());
                    const offsetX = event.relatedTarget.offsetLeft - targetLeft;
                    console.log('offsetX : ' + offsetX);
                    

                    
                    setSelected(event.relatedTarget);

                },
                ondropdeactivate: function (event) {
                    // remove active dropzone feedback
                    event.target.classList.remove('drop-active')
                    event.target.classList.remove('drop-target')
                }
            })

            interact('.drag-drop').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({
                        endOnly: true
                    })
                ],
                manualStart: true,
                autoScroll: true,
                // dragMoveListener from the dragging demo above
                onmove: dragMoveListener
            }).resizable({
                // resize from all edges and corners
                edges: { left: true, right: true, bottom: true, top: true },

                modifiers: [
                // keep the edges inside the parent
                interact.modifiers.restrictEdges({
                    endOnly: true
                }),

                // minimum size
                interact.modifiers.restrictSize({
                    min: { width: 10, height: 10 }
                })
                ],

                inertia: true
            })
            .on('move', function (event) {
                var interaction = event.interaction;

                // if the pointer was moved while being held down
                // and an interaction hasn't started yet
                if (interaction.pointerIsDown && !interaction.interacting()) {
                    var target = event.currentTarget;

                    if (target.getAttribute('palette')) {
                        // create a clone of the currentTarget element
                        var clone = event.currentTarget.cloneNode(true);
                        clone.removeAttribute('palette');

                        console.log(event.currentTarget);
                        
                        var targetBounding = target.getBoundingClientRect();

                        // add dragging class
                        //clone.classList.add("drag-dragging");
                        //clone.classList.remove("drag-dropped");
                        clone.classList.add("drag-drop");
                        clone.classList.add("text-center");
                        
                        // translate the element
                        clone.style.transform = "translate(0px, 0px)";
                        clone.style.position = "absolute";        
                        clone.style.top = (targetBounding.top + window.scrollY) + "px";
                        clone.style.left = (targetBounding.left + window.scrollX) + "px";

                        // update the posiion attributes
                        clone.setAttribute("data-x", 0);
                        clone.setAttribute("data-y", 0);
                        

                        // insert the clone to the page
                        document.body.appendChild(clone);

                        // start a drag interaction targeting the clone
                        interaction.start({ name: 'drag' }, event.interactable, clone);
                
                        clone.setAttribute("state", 'initial');

                    } else {
                        
                        // start a drag interaction targeting the clone
                        interaction.start({ name: 'drag' }, event.interactable, target);
                
                        target.setAttribute("state", 'move');

                    }

                }     
                
            })
            .on('resizemove', function (event) {
                var target = event.target
                var x = (parseFloat(target.getAttribute('data-x')) || 0)
                var y = (parseFloat(target.getAttribute('data-y')) || 0)

                // update the element's style
                target.style.width = event.rect.width + 'px'
                target.style.height = event.rect.height + 'px'

                // translate when resizing from top or left edges
                x += event.deltaRect.left
                y += event.deltaRect.top

                target.style.webkitTransform = target.style.transform =
                    'translate(' + x + 'px,' + y + 'px)'

                target.setAttribute('data-x', x)
                target.setAttribute('data-y', y)
                //target.textContent = Math.round(event.rect.width) + '\u00D7' + Math.round(event.rect.height)
                console.log('coord : '  + Math.round(event.rect.width) + '\u00D7' + Math.round(event.rect.height));

                target.setAttribute("state", 'resize');

            })
            .on('down', function (event) {
                const target = event.target

                setSelected(target);
            })
            .on('up', function (event) {
                const target = event.target


            })



            function setSelected(target) {

                // 선택된 아이템이므로 selected 설정
                if (selectedItem.length > 0) { // 기존에 선택된 아이템이 있으면 selected 해제
                    for (let i = 0; i < selectedItem.length; i++) {
                        selectedItem[i].classList.remove('selected-item');
                    }
                    selectedItem = [];
                }
                
                target.classList.add('selected-item');
                selectedItem.push(target);
                
            }

            function dragMoveListener (event) {
                var target = event.target
                // keep the dragged position in the data-x/data-y attributes
                var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx
                var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy

                // translate the element
                target.style.webkitTransform =
                    target.style.transform =
                    'translate(' + x + 'px, ' + y + 'px)'

                // update the posiion attributes
                target.setAttribute('data-x', x)
                target.setAttribute('data-y', y)
            }

            // this is used later in the resizing and gesture demos
            window.dragMoveListener = dragMoveListener

        </script>

    </body>
</html>