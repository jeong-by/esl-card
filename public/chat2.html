<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Chat Client</title>
		
		<script src="jquery-3.3.1.min.js"></script>    
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.js"></script>
        
        <script>
            var host;
            var port;
            var socket;
            
            var seqCode = 0;

            var callStatus = 'none';

         	// document ready
            $(function() {

            	// event handler for connect button
				$("#connectButton").bind('click', function(event) {
					println('connectButton clicked.');
					
                    host = $('#hostInput').val();
                    port = $('#portInput').val();

                    connectToServer();
                });

				// event handler for invite button
                $("#inviteButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendInvite(sender, receiver, 'video');
                });

				// event handler for accept button
                $("#acceptButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendAccept(sender, receiver, 'video');
                });

				// event handler for bye button
                $("#byeButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendBye(sender, receiver, 'video');
                });

				// event handler for login button
                $("#loginButton").bind('click', function(event) {
                    var id = $('#idInput').val();
                    var password = $('#passwordInput').val();
                    var alias = $('#aliasInput').val();
                    var today = $('#todayInput').val();

                    var requestCode = generateRequestCode();

                    var output = {requestCode:requestCode, userId:id, id:id, password:password, alias:alias, today:today};
                    console.log('OUTPUT : ' + JSON.stringify(output));

                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    socket.emit('login', output);
                });

				// event handler for logout button
                $("#logoutButton").bind('click', function(event) {
                    var id = $('#idInput').val();
                    var requestCode = generateRequestCode();

                    var output = {requestCode:requestCode, userId:id, id:id};
                    console.log('OUTPUT : ' + JSON.stringify(output));

                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    socket.emit('logout', output);
                });

            });
            
			// function for connection
            function connectToServer() {

                var options = {'forceNew':false};
                var url = 'http://' + host + ':' + port;
                socket = io.connect(url, options);

                socket.on('connect', function() {
                	println('Server is connected : ' + url);

                    socket.on('message', function(message) {
                        console.log(JSON.stringify(message));

                        println('<p>message received : ' + message.sender + ', ' + message.receiver 
                                + ', ' + message.command + ', ' + message.method 
                                + ', ' + message.category + ', ' + message.data + '</p>');

                        if (message.command == 'session') {
                            if (message.method == 'trying') {
                                println(message.receiver + '에게 전화 거는 중...');
                            } else if (message.method == 'ringing') {
                                callStatus = 'ringing';

                                println(message.sender + '의 전화벨 울리는 중...');
                            } else if (message.method == 'invite') {
                                sendRinging(message.receiver, message.sender, message.category);

                                println(message.receiver + '에게 전화 요청 받음...');
                            } else if (message.method == 'ok') {
                                if (callStatus == 'ringing') {
                                    callStatus = 'calling';
                                    sendAck(message.receiver, message.sender, message.category);
                                    
                                    println(message.sender + '의 전화받음...');
                                } else if (callStatus == 'bye') {
                                    callStatus = 'none';
                                    
                                    println(message.sender + '의 전화끊음...');
                                }
                            } else if (message.method == 'ack') {
                                if (callStatus == 'ringing') {
                                    callStatus = 'calling';

                                    println(message.sender + '의 전화받음...');
                                }
                            } else if (message.method == 'bye') {    
                                callStatus = 'none';

                                sendOk(message.receiver, message.sender, message.category);
                                
                                println(message.sender + '의 전화끊음...');
                            }
                        }        
                    });

                    socket.on('response', function(response) {
                    	console.log(JSON.stringify(response));
                    	println('response received : ' + response.command + ', ' + response.code + ', ' + response.message);
                    });
                    
                });

                socket.on('disconnect', function() {
                    println('Server disconnected.');
                });

            }
            
            function sendInvite(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'invite',
                    code: '100',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendAccept(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ok',
                    code: '200',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendRinging(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ringing',
                    code: '180',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);

                callStatus = 'ringing';
            }

            function sendAck(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ack',
                    code: '210',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendOk(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ok',
                    code: '200',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendBye(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'bye',
                    code: '400',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);

                callStatus = 'bye';
            }


            /*
             * Generate request code (using time and sequence)
             */
            function generateRequestCode() {
                var date = new Date();

                var seqCodeStr = getSeqCode();
 
                var components = [
                    date.getFullYear(),
                    ("0" + (date.getMonth() + 1)).slice(-2),
                    date.getDate(),
                    date.getHours(),
                    date.getMinutes(),
                    date.getSeconds(),
                    date.getMilliseconds(),
                    seqCodeStr
                ];
 
                var curCode = components.join("");
                return curCode;
            }

            /*
             * Get sequence code (01 ~ 99)
             */
            function getSeqCode() {
                seqCode += 1;
                if (seqCode > 99) {
                    seqCode = 0;
                }
                var seqCodeStr = String(seqCode);
                if (seqCodeStr.length == 1) {
                    seqCodeStr = '0' + seqCodeStr;
                }

                return seqCodeStr;
            }

            
			function println(data) {
				console.log(data);
				$('#result').append('<p>' + data + '</p>');
			}
        </script>
	</head>
<body>
	<h3>Chat Client : 1 to 1 chatting</h3>
	<br>
    <div>
        <input type="text" id="hostInput" value="localhost" />
        <input type="text" id="portInput" value="7001" />

        <input type="button" id="connectButton" value="Connect" />
    </div>
    <br>
    <div>
		<input type="text" id="idInput" value="test01" />
		<input type="password" id="passwordInput" value="123456" />
		<input type="text" id="aliasInput" value="John" />
		<input type="text" id="todayInput" value="Great day!" />

		<input type="button" id="loginButton" value="Login" />
		<input type="button" id="logoutButton" value="Logout" />
	</div>
    <br>
    <div>
    	<div><span>Sender id :</span> <input type="text" id="senderInput" value="test01" /></div>
	    <div><span>Receiver id :</span> <input type="text" id="receiverInput" value="test02" /></div>
	    
		<br>
        <input type="button" id="inviteButton" value="전화걸기" />
        <input type="button" id="acceptButton" value="전화받기" />
        <input type="button" id="byeButton" value="전화끊기" />
	</div>    
        
    <hr/>
    <p>Result : </p>
    <div id="result"></div>
        
</body>
</html>