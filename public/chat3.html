<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Chat Client</title>
        
        
        <style>
    
            * {
                padding:0;
                margin:0;
                box-sizing: border-box;
            }

            html, body {
                width: 100%;
                height: 100%;
            }

            #localVideo {
                border:2px solid #FF0000;
                position:relative;
                width:100%;
                height:100%;
                display:inline-block;
                object-fit: fill;
            }

            #remoteVideo {
                border:2px solid #0000FF;
                position: relative;
                width:10em;
                height:13em;
                display:inline-block;
                object-fit: fill;
            }
        
        </style>    


		<script src="jquery-3.3.1.min.js"></script>    
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.js"></script>
        
        <script>
            var localVideo;
            var localStream;

            var remoteVideo;
            var remoteStream;

            var conn;

            // STUN, TURN 서버 리스트 -> https://gist.github.com/yetithefoot/7592580
            var config = {
                'iceServers': [
                    {
                        urls: 'stun:stun.l.google.com:19302'
                    },
                    {
                        urls: 'turn:numb.viagenie.ca',
                        credential: 'muazkh',
                        username: 'webrtc@live.com'
                    }
                ]
            }
 
            var socket;
            //var url = 'https://192.168.0.4:7001';
            var url = 'https://172.20.10.4:7001';



            var host;
            var port;
            var socket;
            
            var seqCode = 0;

            var callStatus = 'none';

         	// document ready
            $(function() {

            	// event handler for connect button
				$("#connectButton").bind('click', function(event) {
					println('connectButton clicked.');
					
                    host = $('#hostInput').val();
                    port = $('#portInput').val();

                    connectToServer();
                });

				// event handler for invite button
                $("#inviteButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendInvite(sender, receiver, 'video');
                });

				// event handler for accept button
                $("#acceptButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendAccept(sender, receiver, 'video');
                });

				// event handler for bye button
                $("#byeButton").bind('click', function(event) {
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                    
                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    sendBye(sender, receiver, 'video');
                });

				// event handler for login button
                $("#loginButton").bind('click', function(event) {
                    var id = $('#idInput').val();
                    var password = $('#passwordInput').val();
                    var alias = $('#aliasInput').val();
                    var today = $('#todayInput').val();

                    var requestCode = generateRequestCode();

                    var output = {requestCode:requestCode, userId:id, id:id, password:password, alias:alias, today:today};
                    console.log('OUTPUT : ' + JSON.stringify(output));

                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    socket.emit('login', output);
                });

				// event handler for logout button
                $("#logoutButton").bind('click', function(event) {
                    var id = $('#idInput').val();
                    var requestCode = generateRequestCode();

                    var output = {requestCode:requestCode, userId:id, id:id};
                    console.log('OUTPUT : ' + JSON.stringify(output));

                    if (socket == undefined) {
                        alert('Server is not connected. Connect to the server first.');
                        return;
                    }

                    socket.emit('logout', output);
                });


                setRemoteDimension();
                setLocalDimension();

                window.addEventListener('resize', function() {
                    setRemoteDimension();
                    setLocalDimension();
                });
                
                init();

            });
            
			// function for connection
            function connectToServer() {

                var options = {'forceNew':false};
                var url = 'https://' + host + ':' + port;
                socket = io.connect(url, options);

                socket.on('connect', function() {
                	println('Server is connected : ' + url);

                    socket.on('message', function(message) {
                        console.log(JSON.stringify(message));

                        println('<p>message received : ' + message.sender + ', ' + message.receiver 
                                + ', ' + message.command + ', ' + message.method 
                                + ', ' + message.category + ', ' + message.data + '</p>');

                        if (message.command == 'session') {
                            if (message.method == 'trying') {
                                println(message.receiver + '에게 전화 거는 중...');
                            } else if (message.method == 'ringing') {
                                callStatus = 'ringing';

                                println(message.sender + '의 전화벨 울리는 중...');
                            } else if (message.method == 'invite') {
                                sendRinging(message.receiver, message.sender, message.category);

                                println(message.receiver + '에게 전화 요청 받음...');
                            } else if (message.method == 'ok') {
                                if (callStatus == 'ringing') {
                                    callStatus = 'calling';
                                    sendAck(message.receiver, message.sender, message.category);
                                
                                    println(message.sender + '의 전화받음...');

                                    call();

                                } else if (callStatus == 'bye') {
                                    callStatus = 'none';
                                    
                                    println(message.sender + '의 전화끊음...');
                                }
                            } else if (message.method == 'ack') {
                                if (callStatus == 'ringing') {
                                    callStatus = 'calling';

                                    println(message.sender + '의 전화받음...');

                                    //call();
                                }
                            } else if (message.method == 'bye') {    
                                callStatus = 'none';

                                sendOk(message.receiver, message.sender, message.category);
                                
                                println(message.sender + '의 전화끊음...');
                            } else if (message.method == 'sdp') {
                                var data1 = message.data;

                                if (data1.type == 'offer') {
                                    println('A user offered call.');
                                    
                                    conn.setRemoteDescription(new RTCSessionDescription(data1));
                                    
                                    doAnswer();

                                } else if (data1.type == 'answer') {
                                    conn.setRemoteDescription(new RTCSessionDescription(data1));
                                
                                }

                            } else if (message.method == 'candidate') {
                                var data2 = message.data;

                                if (data2.type == 'candidate') {
                                    var candidate = new RTCIceCandidate({
                                        sdpMLineIndex: data2.label,
                                        candidate: data2.candidate
                                    })

                                    console.log('candidate : ' + candidate);

                                    //setTimeout(function() {
                                        conn.addIceCandidate(candidate);
                                    //}, 1000)
                                    
                                
                                }
                            }
                        }        
                    });

                    socket.on('response', function(response) {
                    	console.log(JSON.stringify(response));
                    	println('response received : ' + response.command + ', ' + response.code + ', ' + response.message);
                    });
                    
                });

                socket.on('disconnect', function() {
                    println('Server disconnected.');
                });

            }
            
            function sendInvite(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'invite',
                    code: '100',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendAccept(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ok',
                    code: '200',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendRinging(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ringing',
                    code: '180',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);

                callStatus = 'ringing';
            }

            function sendAck(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ack',
                    code: '210',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendOk(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'ok',
                    code: '200',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendBye(sender, receiver, category) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'bye',
                    code: '400',
                    category: category,
                    data:''
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);

                callStatus = 'bye';
            }


            /*
             * Generate request code (using time and sequence)
             */
            function generateRequestCode() {
                var date = new Date();

                var seqCodeStr = getSeqCode();
 
                var components = [
                    date.getFullYear(),
                    ("0" + (date.getMonth() + 1)).slice(-2),
                    date.getDate(),
                    date.getHours(),
                    date.getMinutes(),
                    date.getSeconds(),
                    date.getMilliseconds(),
                    seqCodeStr
                ];
 
                var curCode = components.join("");
                return curCode;
            }

            /*
             * Get sequence code (01 ~ 99)
             */
            function getSeqCode() {
                seqCode += 1;
                if (seqCode > 99) {
                    seqCode = 0;
                }
                var seqCodeStr = String(seqCode);
                if (seqCodeStr.length == 1) {
                    seqCodeStr = '0' + seqCodeStr;
                }

                return seqCodeStr;
            }

            
			function println(data) {
				console.log(data);
				$('#result').append('<p>' + data + '</p>');
            }
            

             
            function setRemoteDimension() {
                var windowWidth = $(window).width();
                var windowHeight = $(window).height();
                //alert('window -> ' + windowWidth + ', ' + windowHeight);

                var remoteWidth = windowWidth;
                var remoteHeight = windowHeight;
                //alert('remoteVideo -> ' + remoteWidth + ', ' + remoteHeight);

                $('#remoteVideo').width(remoteWidth-4);
                $('#remoteVideo').height(remoteHeight-4);

                $('#remoteVideo').offset({top:0, left:0});
            }

            function setLocalDimension() {
                var remoteWidth = $('#remoteVideo').innerWidth();
                var remoteHeight = $('#remoteVideo').innerHeight();
                console.log('remoteVideo -> ' + remoteWidth + ', ' + remoteHeight);

                var localWidth = remoteWidth * (3/9);
                var localHeight = remoteHeight * (3/9);
                console.log('localVideo -> ' + localWidth + ', ' + localHeight);

                $('#localVideo').width(localWidth);
                $('#localVideo').height(localHeight);

                var offsetTop = remoteHeight - localHeight - 10;
                var offsetLeft = remoteWidth - localWidth - 10;
                
                $('#localVideo').offset({top:offsetTop, left:offsetLeft});

                console.log('localVideo offset -> ' + offsetTop + ', ' + offsetLeft);

            }

            function init() {
                // 로컬 미디어 초기화하기
                getLocalMedia();

                /*
                // Socket.IO 연결하기
                socket = io.connect(url);
 
                socket.on('connect', function() {
                    console.log('socket connect called -> ' + socket.id);

                });
 
                socket.on('ipaddr', function(ipaddr) {
                    console.log('socket ipaddr called (Server IP address) -> ' + ipaddr);

                });

                socket.on('message', function(data) {
                    console.log('socket message event -> ' + JSON.stringify(data));

                    if (data.command) {
                        if (data.command == 'hangup') {
                            hangup(false);
                        }

                        return;
                    }

                    if (data.type == 'offer') {
                        println('A user offered call.');
                        
                        conn.setRemoteDescription(new RTCSessionDescription(data));
                        
                        doAnswer();

                    } else if (data.type == 'answer') {
                        conn.setRemoteDescription(new RTCSessionDescription(data));
                    
                    } else if (data.type == 'candidate') {
                        var candidate = new RTCIceCandidate({
                            sdpMLineIndex: data.label,
                            candidate: data.candidate
                        })
                        conn.addIceCandidate(candidate);
                    
                    }

                })
                */

            }

            window.onbeforeunload = function() {
                var data = {
                    command: 'hangup'
                };

                sendMessage(data);
            }

            function sendMessage(data) {
                console.log('sendMessage called -> ' + JSON.stringify(data));

                socket.emit('message', data);
            }

            function doAnswer() {
                console.log('doAnswer called');

                conn.createAnswer()
                    .then(onCreated, onCreateAnswerError);
            }

            function onCreateAnswerError(error) {
                console.log('onCreateAnswerError -> ' + error);

            }

            function getLocalMedia() {
                // video 태그 참조
                localVideo = document.getElementById('localVideo');
                remoteVideo = document.getElementById('remoteVideo');

                results = document.getElementById('results');

                // video 태그의 리스너 설정
                localVideo.addEventListener('loadedmetadata', function() {
                    console.log('localVideo loadedmetadata event -> ' + localVideo.videoWidth + ', ' + localVideo.videoHeight);
                });

                remoteVideo.addEventListener('loadedmetadata', function() {
                    console.log('remoteVideo loadedmetadata event -> ' + remoteVideo.videoWidth + ', ' + remoteVideo.videoHeight);
                });

                localVideo.addEventListener('resize', function() {
                    console.log('localVideo resize event -> ' + localVideo.videoWidth + ', ' + localVideo.videoHeight);
                });
                
                remoteVideo.addEventListener('resize', function() {
                    console.log('remoteVideo resize event -> ' + remoteVideo.videoWidth + ', ' + remoteVideo.videoHeight);
                });



                // getUserMedia 메소드를 호출하여 Local Stream 객체 가져오기
                navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: true
                })
                .then(gotLocalStream)
                .catch(function(err) {
                    alert('getUserMedia error -> ' + err);
                });
            }

            // getUserMedia 메소드 호출 결과
            function gotLocalStream(stream) {
                console.log('gotLocalStream called.');

                // mute local voice
                //localVideo.volume = 0;

                localStream = stream;
                localVideo.srcObject = stream;

                // PeerConnection 객체 생성
                createPeerConnection();
            }
        
            function call() {
                conn.createOffer(onCreated, onCreateOfferError);
            }

            function onCreated(sdp) {
                conn.setLocalDescription(sdp);
                console.log('local sdp -> ' + JSON.stringify(sdp));
 
                //sendMessage(sdp);

                var sender = $('#senderInput').val();
                var receiver = $('#receiverInput').val();
                    
                sendSdp(sender, receiver, 'video', sdp);
                
            }

            function onCreateOfferError(error) {
                console.log('onCreateOfferError -> ' + error);

            }

            function createPeerConnection() {
                try {
                    conn = new RTCPeerConnection(config);
                    
                    // 이벤트 처리 함수 등록
                    conn.onicecandidate = onIceCandidate;
                    conn.onaddstream = onRemoteStreamAdded;
                    conn.onremovestream = onRemoteStreamRemoved;

                    // 로컬 스트림 추가
                    conn.addStream(localStream);

                    console.log('RTCPeerConnection created.');
                } catch(err) {
                    console.error('Failed to create RTCPeerConnection -> ' + err);
                    return;
                }
            }

            function onIceCandidate(event) {
                console.log('onIceCandidate called -> ' + JSON.stringify(event));

                if (event.candidate) {
                    /*
                    sendMessage({
                        type: 'candidate',
                        label: event.candidate.sdpMLineIndex,
                        id: event.candidate.sdpMid,
                        candidate: event.candidate.candidate
                    });
                    */

                    var candidate = {
                        type: 'candidate',
                        label: event.candidate.sdpMLineIndex,
                        id: event.candidate.sdpMid,
                        candidate: event.candidate.candidate
                    };
                    
                    var sender = $('#senderInput').val();
                    var receiver = $('#receiverInput').val();
                        
                    sendCandidate(sender, receiver, 'video', candidate);
                
 
                } else {
                    console.log('End of candidate');
                }
            }

            function onRemoteStreamAdded(event) {
                console.log('onRemoteStreamAdded called -> ' + JSON.stringify(event));

                remoteStream = event.stream;
                remoteVideo.srcObject = remoteStream;
            }

            function onRemoteStreamRemoved(event) {
                console.log('onRemoteStreamRemoved called -> ' + JSON.stringify(event));

            }
 
            function hangup(resend) {
                console.log('hangup called.');

                if (conn) {
                    conn.close();
                    conn = null;
                }

                if (localStream) {
                    localStream.getTracks().forEach(function(track) {
                        track.stop()
                    });

                    localStream = null;
                }
 
                if (remoteStream) {
                    remoteStream.getTracks().forEach(function(track) {
                        track.stop()
                    });

                    remoteStream = null;
                }
 
                if (resend) {
                    var data = {
                        command: 'hangup'
                    };
                    sendMessage(data);
                }
            }

            function answer() {
                console.log('answer called.');

            }

             
            function sendSdp(sender, receiver, category, sdp) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'sdp',
                    code: '310',
                    category: category,
                    data:sdp
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }

            function sendCandidate(sender, receiver, category, candidate) {
                var requestCode = generateRequestCode();

                var output = {
                    requestCode:requestCode, 
                    userId:sender, 
                    sender:sender, 
                    receiver:receiver, 
                    command:'session', 
                    method:'candidate',
                    code: '320',
                    category: category,
                    data:candidate
                };
                console.log('OUTPUT : ' + JSON.stringify(output));

                if (socket == undefined) {
                    alert('Server is not connected. Connect to the server first.');
                    return;
                }

                socket.emit('message', output);
            }



        </script>
	</head>
<body>
    
    <div>
        
        <video playsinline autoplay preload="metadata" id="remoteVideo"></video>
        <video playsinline autoplay muted preload="metadata" id="localVideo"></video>

    </div>    
        
	<h3>Chat Client : 1 to 1 chatting</h3>
	<br>
    <div>
        <input type="text" id="hostInput" value="localhost" />
        <input type="text" id="portInput" value="7001" />

        <input type="button" id="connectButton" value="Connect" />
    </div>
    <br>
    <div>
		<input type="text" id="idInput" value="test01" />
		<input type="password" id="passwordInput" value="123456" />
		<input type="text" id="aliasInput" value="John" />
		<input type="text" id="todayInput" value="Great day!" />

		<input type="button" id="loginButton" value="Login" />
		<input type="button" id="logoutButton" value="Logout" />
	</div>
    <br>
    <div>
    	<div><span>Sender id :</span> <input type="text" id="senderInput" value="test01" /></div>
	    <div><span>Receiver id :</span> <input type="text" id="receiverInput" value="test02" /></div>
	    
		<br>
        <input type="button" id="inviteButton" value="전화걸기" />
        <input type="button" id="acceptButton" value="전화받기" />
        <input type="button" id="byeButton" value="전화끊기" />
	</div>    
        

    <hr/>
    <p>Result : </p>
    <div id="result"></div>
        
</body>
</html>